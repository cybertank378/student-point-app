generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/////////////////////////////////////////////////////
// ENUMS
/////////////////////////////////////////////////////

enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum TeacherRole {
  SUBJECT_TEACHER
  HOMEROOM
  COUNSELOR
  DUTY_TEACHER
}

enum StudentStatus {
  ACTIVE
  GRADUATED
  DROPPED
  MUTATION
}

enum Gender {
  MALE
  FEMALE
}

enum ParentType {
  FATHER
  MOTHER
  GUARDIAN
}

enum ViolationLevel {
  LIGHT
  MEDIUM
  HEAVY
}

enum ViolationResolutionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ESCALATED
}

enum ViolationActionType {
  WARNING
  WRITTEN_NOTICE
  COUNSELING
  PARENT_CALL
  SUSPENSION
}

/////////////////////////////////////////////////////
// AUTH MODULE
/////////////////////////////////////////////////////

model User {
  id           String       @id @default(uuid())
  username     String       @unique
  password     String
  image        String?
  role         Role
  teacherRole  TeacherRole?
  refreshToken String?

  isActive           Boolean   @default(true)
  version            Int       @default(1)
  failedAttempts     Int       @default(0)
  lockUntil          DateTime?
  mustChangePassword Boolean   @default(false)

  studentId String?
  parentId  String?

  student Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent?  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  teacher Teacher?

  sessions    AuthSession[]
  resetTokens PasswordResetToken[]
  loginAudits LoginAudit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId])
  @@unique([parentId])
  @@unique([id, version])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@index([role, isActive])
  @@index([studentId])
  @@index([parentId])
  @@index([isActive, createdAt])
}

/////////////////////////////////////////////////////
// AUTH SESSION
/////////////////////////////////////////////////////

model AuthSession {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)

  device String?
  ip     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([revoked])
}

/////////////////////////////////////////////////////
// PASSWORD RESET TOKEN
/////////////////////////////////////////////////////

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([used])
}

/////////////////////////////////////////////////////
// LOGIN AUDIT
/////////////////////////////////////////////////////

model LoginAudit {
  id         String  @id @default(uuid())
  userId     String?
  identifier String
  success    Boolean
  ip         String?
  userAgent  String?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([identifier])
  @@index([createdAt])
  @@index([success])
}

/////////////////////////////////////////////////////
// ACADEMIC YEAR
/////////////////////////////////////////////////////

model AcademicYear {
  id        String   @id @default(uuid())
  name      String   @unique
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  isActive  Boolean  @default(false)

  classes Class[]

  createdAt DateTime @default(now())

  @@index([isActive])
}

/////////////////////////////////////////////////////
// CLASS
/////////////////////////////////////////////////////

model Class {
  id                String  @id @default(uuid())
  grade             String
  name              String
  academicYearId    String
  homeroomTeacherId String? @unique

  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  homeroomTeacher Teacher?     @relation("HomeroomTeacher", fields: [homeroomTeacherId], references: [id])
  students        Student[]

  createdAt DateTime @default(now())

  @@unique([grade, name, academicYearId])
  @@index([academicYearId])
  @@index([grade])
}

/////////////////////////////////////////////////////
// STUDENT
/////////////////////////////////////////////////////

model Student {
  id       String  @id @default(uuid())
  nisn     Int     @unique
  nis      Int     @unique
  name     String
  nickname String?

  gender     Gender
  religionId String
  rombelId   String

  status    StudentStatus @default(ACTIVE)
  deletedAt DateTime?

  religion Religion @relation(fields: [religionId], references: [id])
  rombel   Class    @relation(fields: [rombelId], references: [id])

  profile StudentProfile?

  // ðŸ”¥ pivot relation
  parents StudentParent[]

  users        User[]
  violations   StudentViolation[]
  achievements StudentAchievement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rombelId])
  @@index([religionId])
  @@index([status])
  @@index([deletedAt])
  @@index([name])
}

/////////////////////////////////////////////////////
// STUDENT PROFILE
/////////////////////////////////////////////////////

model StudentProfile {
  id        String @id @default(uuid())
  studentId String @unique

  birthPlace String
  birthDate  DateTime
  address    String

  distanceToSchool  String
  transportToSchool String
  previousSchool    String

  hobby    String?
  ambition String?

  phone     String?
  email     String?
  instagram String?

  internetAccess String?
  hasLaptop      Boolean
  hasPC          Boolean
  hasPhone       Boolean

  kjpRecipient Boolean
  pipRecipient Boolean

  specialNeeds Boolean
  inclusion    Boolean

  student Student @relation(fields: [studentId], references: [id])
}

/////////////////////////////////////////////////////
// RELIGION
/////////////////////////////////////////////////////

model Religion {
  id   String @id @default(uuid())
  kode String @unique
  name String

  students Student[]

  @@index([name])
}

/////////////////////////////////////////////////////
// PARENT
/////////////////////////////////////////////////////

model Parent {
  id String @id @default(uuid())

  name      String
  email     String?
  education String
  job       String
  income    String?
  religion  String
  phone     String  @unique
  address   String

  // ðŸ”¥ pivot relation
  students StudentParent[]

  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([phone])
  @@index([name])
}

/////////////////////////////////////////////////////
// PIVOT TABLE STUDENT PARENT
/////////////////////////////////////////////////////

model StudentParent {
  id        String     @id @default(uuid())
  studentId String
  parentId  String
  role      ParentType

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([studentId, parentId]) // mencegah parent sama didaftarkan 2x
  @@unique([studentId, role]) // ðŸ”¥ mencegah 2 FATHER / 2 MOTHER
  @@index([studentId])
  @@index([parentId])
  @@index([role])
}

/////////////////////////////////////////////////////
// TEACHER
/////////////////////////////////////////////////////

model Teacher {
  id    String  @id @default(uuid())
  nip   String  @unique
  name  String
  phone String?
  email String?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  roles TeacherRole[]

  homeroomOf Class? @relation("HomeroomTeacher")

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  ViolationResolution ViolationResolution[]

  @@index([name])
}

/////////////////////////////////////////////////////
// VIOLATION
/////////////////////////////////////////////////////

model Violation {
  id        String         @id @default(uuid())
  name      String         @unique
  point     Int
  level     ViolationLevel
  deletedAt DateTime?

  records StudentViolation[]

  createdAt DateTime @default(now())

  @@index([level])
  @@index([deletedAt])
}

/////////////////////////////////////////////////////
// VIOLATION RESOLUTION
/////////////////////////////////////////////////////

model ViolationResolution {
  id                 String @id @default(uuid())
  studentViolationId String @unique
  handlerTeacherId   String

  status ViolationResolutionStatus
  action ViolationActionType

  note String?

  resolvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  studentViolation StudentViolation     @relation(fields: [studentViolationId], references: [id])
  handlerTeacher   Teacher              @relation(fields: [handlerTeacherId], references: [id])
  logs             ViolationActionLog[]

  @@index([handlerTeacherId])
  @@index([status])
}

/////////////////////////////////////////////////////
// VIOLATION ACTION LOG
/////////////////////////////////////////////////////

model ViolationActionLog {
  id           String              @id @default(uuid())
  resolutionId String
  action       ViolationActionType
  note         String?
  createdAt    DateTime            @default(now())

  resolution ViolationResolution @relation(fields: [resolutionId], references: [id])

  @@index([resolutionId])
  @@index([createdAt])
}

/////////////////////////////////////////////////////
// STUDENT VIOLATION
/////////////////////////////////////////////////////

model StudentViolation {
  id          String   @id @default(uuid())
  studentId   String
  violationId String
  point       Int
  occurredAt  DateTime

  student   Student   @relation(fields: [studentId], references: [id])
  violation Violation @relation(fields: [violationId], references: [id])

  createdAt DateTime @default(now())

  resolution ViolationResolution?

  @@index([studentId])
  @@index([violationId])
  @@index([occurredAt])
}

/////////////////////////////////////////////////////
// ACHIEVEMENT
/////////////////////////////////////////////////////

model Achievement {
  id        String    @id @default(uuid())
  name      String    @unique // âœ… wajib ada ini
  point     Int
  deletedAt DateTime?
  createdAt DateTime  @default(now())

  records StudentAchievement[]
}

/////////////////////////////////////////////////////
// STUDENT ACHIEVEMENT
/////////////////////////////////////////////////////

model StudentAchievement {
  id            String   @id @default(uuid())
  studentId     String
  achievementId String
  point         Int
  achievedAt    DateTime
  createdAt     DateTime @default(now())

  student     Student     @relation(fields: [studentId], references: [id])
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([studentId, achievementId])
}
